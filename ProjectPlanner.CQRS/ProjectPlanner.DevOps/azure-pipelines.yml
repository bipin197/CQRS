trigger:
  branches:
    include:
    - main
  paths:
    include:
    - ProjectPlanner.Api/*
    - ProjectPlanner.Commands/*
    - ProjectPlanner.Queries/*
    - ProjectPlanner.Domain/*

variables:
  - name: AWS_REGION
    value: 'ap-south-1'
  - name: ECR_REPOSITORY
    value: 'projectplanner-api'
  - name: IMAGE_TAG
    value: '$(Build.BuildNumber)'

stages:
- stage: Infrastructure
  displayName: 'Setup Infrastructure'
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
  jobs:
  - job: SetupInfrastructure
    displayName: 'Create ECR and Variable Group'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AWSShellScript@1
      name: createEcr
      inputs:
        awsCredentials: 'AWS'
        regionName: $(AWS_REGION)
        scriptType: 'inline'
        inlineScript: |
          # Check if repository exists
          if ! aws ecr describe-repositories --repository-names $(ECR_REPOSITORY) --region $(AWS_REGION) 2>/dev/null; then
            # Create ECR repository
            aws ecr create-repository --repository-name $(ECR_REPOSITORY) --region $(AWS_REGION)
            
            # Enable image scanning
            aws ecr put-image-scanning-configuration \
              --repository-name $(ECR_REPOSITORY) \
              --image-scanning-configuration scanOnPush=true \
              --region $(AWS_REGION)
            
            # Set lifecycle policy
            POLICY='{
              "rules": [{
                "rulePriority": 1,
                "description": "Remove untagged images older than 14 days",
                "selection": {
                  "tagStatus": "untagged",
                  "countType": "sinceImagePushed",
                  "countUnit": "days",
                  "countNumber": 14
                },
                "action": {
                  "type": "expire"
                }
              }]
            }'
            
            aws ecr put-lifecycle-policy \
              --repository-name $(ECR_REPOSITORY) \
              --lifecycle-policy-text "$POLICY" \
              --region $(AWS_REGION)
          fi

    - task: AWSShellScript@1
      name: getAccountId
      inputs:
        awsCredentials: 'AWS'
        regionName: $(AWS_REGION)
        scriptType: 'inline'
        inlineScript: |
          # Get AWS Account ID
          ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)
          echo "##vso[task.setvariable variable=AWS_ACCOUNT_ID]$ACCOUNT_ID"

- stage: Build
  displayName: 'Build and Push'
  jobs:
  - job: BuildAndPush
    displayName: 'Build and Push Docker Image'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x'
        installationPath: $(Agent.ToolsDirectory)/dotnet
      displayName: 'Install .NET 8 SDK'

    - task: AWSShellScript@1
      inputs:
        awsCredentials: 'AWS'  # AWS Service Connection name
        regionName: $(AWS_REGION)
        scriptType: 'inline'
        inlineScript: |
          aws ecr get-login-password --region $(AWS_REGION) | docker login --username AWS --password-stdin $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com
      displayName: 'Login to ECR'
      env:
        AWS_ACCOUNT_ID: $(AWS_ACCOUNT_ID)

    - task: Docker@2
      inputs:
        command: 'build'
        Dockerfile: '**/ProjectPlanner.Api/Dockerfile'
        buildContext: '$(Build.SourcesDirectory)'
        tags: |
          $(ECR_REPOSITORY):$(IMAGE_TAG)
          $(ECR_REPOSITORY):latest
      displayName: 'Build Docker Image'

    - task: AWSShellScript@1
      inputs:
        awsCredentials: 'AWS'  # AWS Service Connection name
        regionName: $(AWS_REGION)
        scriptType: 'inline'
        inlineScript: |
          # Tag and push image with build number
          docker tag $(ECR_REPOSITORY):$(IMAGE_TAG) $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(ECR_REPOSITORY):$(IMAGE_TAG)
          docker push $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(ECR_REPOSITORY):$(IMAGE_TAG)
          
          # Tag and push as latest
          docker tag $(ECR_REPOSITORY):$(IMAGE_TAG) $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(ECR_REPOSITORY):latest
          docker push $(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(ECR_REPOSITORY):latest
      displayName: 'Push to ECR'
      env:
        AWS_ACCOUNT_ID: $(AWS_ACCOUNT_ID)
